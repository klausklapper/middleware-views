{"version":3,"file":"index.js","sources":["../src/index.ts","../src/utils.ts"],"sourcesContent":["import type { Middleware } from 'pinecone-router';\nimport { renderContent } from './utils.js';\n\nconst PineconeRouterMiddleware: Middleware = {\n\t/**\n\t * @property {string} version the version of Pinecone Router this middleware is made for.\n\t */\n\tversion: '1.2.0',\n\n\t/**\n\t * @property {string} name the name of the middleware.\n\t * used as key to the middleware settings object.\n\t */\n\tname: 'Views',\n\n\t/**\n\t * @summary it hold the views of each route.\n\t * the route being the index and value is its view.\n\t */\n\tviews: <{ [key: string]: string }>{},\n\n\t/**\n\t * @property {{[key: string]: string}} settings the middleware settings.\n\t */\n\tsettings: <{ [key: string]: any }>{\n\t\tenable: false,\n\t\tbasePath: '/',\n\t\tselector: '#app',\n\t\t/**\n\t\t * @type {string}\n\t\t * @summary the 404 view\n\t\t */\n\t\tnotfound: null,\n\t},\n\n\t/**\n\t * @event pinecone-start\n\t * @summary be dispatched to the window after before page start loading.\n\t */\n\tloadStart: new Event('pinecone-start'),\n\n\t/**\n\t * @event pinecone-end\n\t * @summary will be dispatched to the window after the views are fetched\n\t */\n\tloadEnd: new Event('pinecone-end'),\n\n\t/**\n\t * This will be called at router initialization.\n\t * used for detecting router settings.\n\t */\n\tinit(_component, settings) {\n\t\tif (settings.middlewares?.render) {\n\t\t\tthrow new Error(\n\t\t\t\t`Pinecone Router ${this.name}: Cannot use views middleware along with render.`\n\t\t\t);\n\t\t}\n\n\t\t//load settings\n\t\tthis.settings = {\n\t\t\t...this.settings,\n\t\t\t...(settings.middlewares[this.name.toLowerCase()] ?? {}),\n\t\t};\n\n\t\tif (this.settings?.selector == 'body') {\n\t\t\tthrow new Error(\n\t\t\t\t`Pinecone Router ${this.name}: Do not use body as the selector, it will cause the router component to be removed`\n\t\t\t);\n\t\t}\n\n\t\twindow.PineconeRouter.settings.allowNoHandler = true;\n\t},\n\n\t/**\n\t * Called for each route during initialization,\n\t * before the route is processed & added.\n\t */\n\tonBeforeRouteProcessed(el, _component, path) {\n\t\tif (this.settings!.enable) {\n\t\t\tif (el.hasAttribute('x-view')) {\n\t\t\t\tlet view = el.getAttribute('x-view');\n\t\t\t\tif (this.settings!.basePath != '/') {\n\t\t\t\t\tview = this.settings!.basePath + view;\n\t\t\t\t}\n\n\t\t\t\tif (path == 'notfound') {\n\t\t\t\t\tthis.settings!.notfound = view;\n\t\t\t\t} else {\n\t\t\t\t\tthis.views[path] = view;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * Will be called after the handlers are executed and done.\n\t * during navigation inside PineconeRouter.navigate().\n\t */\n\tonHandlersExecuted(route, _, firstLoad) {\n    // allow SSG\n    if (firstLoad) {\n      let main = document.querySelector(this.settings!.selector)\n      if (main.innerText.length !== 0 && main.getAttribute('x-route') === route.path) {\n        window.dispatchEvent(this.loadEnd);\n        return\n      }\n    }\n\t\tif (this.settings!.enable) {\n\t\t\tlet view: string|null = !route ? this.settings!.notfound : this.views[route.path] ?  this.views[route.path]: null;\n\t\t\tif (view == null) return;\n\t\t\tfetch(view)\n\t\t\t\t.then((response) => {\n\t\t\t\t\treturn response.text();\n\t\t\t\t})\n\t\t\t\t.then((response) => {\n\t\t\t\t\trenderContent(response, this.settings!.selector);\n\t\t\t\t\twindow.dispatchEvent(this.loadEnd);\n\t\t\t\t\treturn false;\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tdocument\n\t\t\t\t\t\t.querySelector('[x-router][x-data]')!\n\t\t\t\t\t\t.dispatchEvent(\n\t\t\t\t\t\t\tnew CustomEvent('fetch-error', { detail: error })\n\t\t\t\t\t\t);\n\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t`Pinecone Router ${this.name}: Fetch Error: ${error}`\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t}\n\t},\n\n\tonBeforeHandlersExecuted(_route) {\n\t\twindow.dispatchEvent(this.loadStart);\n\t},\n};\n\nif (window.PineconeRouterMiddlewares == null)\n\twindow.PineconeRouterMiddlewares = [PineconeRouterMiddleware];\nelse window.PineconeRouterMiddlewares.push(PineconeRouterMiddleware);\n","/**\n * This will replace the content fetched from `path` into `selector`.\n * The content is assumed to not be an entire html page but a chunk of it.\n */\nexport function renderContent(content: string, selector: string) {\n\t// replace the content of the selector with the fetched content\n\tdocument.querySelector(selector)!.innerHTML = content;\n    // @ts-ignore\n    document.querySelector('[autofocus]')?.focus()\n}\n"],"names":["PineconeRouterMiddleware","version","name","views","settings","enable","basePath","selector","notfound","loadStart","Event","loadEnd","init","_component","middlewares","_settings$middlewares","render","Error","this","toLowerCase","window","PineconeRouter","allowNoHandler","onBeforeRouteProcessed","el","path","hasAttribute","view","getAttribute","onHandlersExecuted","route","_","firstLoad","main","document","querySelector","innerText","length","dispatchEvent","fetch","then","response","text","content","_this","innerHTML","focus","catch","error","CustomEvent","detail","console","onBeforeHandlersExecuted","_route","PineconeRouterMiddlewares","push"],"mappings":"+MAGA,IAAMA,EAAuC,CAI5CC,QAAS,QAMTC,KAAM,QAMNC,MAAkC,GAKlCC,SAAkC,CACjCC,QAAQ,EACRC,SAAU,IACVC,SAAU,OAKVC,SAAU,MAOXC,UAAW,IAAIC,MAAM,kBAMrBC,QAAS,IAAID,MAAM,gBAMnBE,cAAKC,EAAYT,aAChB,YAAIA,EAASU,cAATC,EAAsBC,OACzB,UAAUC,yBACUC,KAAKhB,yDAU1B,GALAgB,KAAKd,cACDc,KAAKd,kBACJA,EAASU,YAAYI,KAAKhB,KAAKiB,kBAAkB,IAGvB,uBAAtBf,mBAAUG,UAClB,UAAUU,yBACUC,KAAKhB,4FAI1BkB,OAAOC,eAAejB,SAASkB,gBAAiB,GAOjDC,gCAAuBC,EAAIX,EAAYY,GACtC,GAAIP,KAAKd,SAAUC,QACdmB,EAAGE,aAAa,UAAW,CAC9B,IAAIC,EAAOH,EAAGI,aAAa,UACI,KAA3BV,KAAKd,SAAUE,WAClBqB,EAAOT,KAAKd,SAAUE,SAAWqB,GAGtB,YAARF,EACHP,KAAKd,SAAUI,SAAWmB,EAE1BT,KAAKf,MAAMsB,GAAQE,IAUvBE,4BAAmBC,EAAOC,EAAGC,cAE1B,GAAIA,EAAW,CACb,IAAIC,EAAOC,SAASC,cAAcjB,KAAKd,SAAUG,UACjD,GAA8B,IAA1B0B,EAAKG,UAAUC,QAAgBJ,EAAKL,aAAa,aAAeE,EAAML,KAExE,YADAL,OAAOkB,cAAcpB,KAAKP,SAIhC,GAAIO,KAAKd,SAAUC,OAAQ,CAC1B,IAAIsB,EAAqBG,EAAkCZ,KAAKf,MAAM2B,EAAML,MAASP,KAAKf,MAAM2B,EAAML,MAAO,KAA5EP,KAAKd,SAAUI,SAChD,GAAY,MAARmB,EAAc,OAClBY,MAAMZ,GACJa,KAAK,SAACC,GACN,OAAOA,EAASC,SAEhBF,KAAK,SAACC,OC9GmBE,IDiHzB,OCjHyBA,ED+GXF,EC7GlBP,SAASC,cD6GmBS,EAAKxC,SAAUG,UC7GTsC,UAAYF,WAE3CT,SAASC,cAAc,mBAAgBW,QD4GtC1B,OAAOkB,cAAcM,EAAKjC,cAG1BoC,MAAM,SAACC,GACPd,SACEC,cAAc,sBACdG,cACA,IAAIW,YAAY,cAAe,CAAEC,OAAQF,KAE3CG,QAAQH,yBACYJ,EAAK1C,uBAAsB8C,OAMnDI,kCAAyBC,GACxBjC,OAAOkB,cAAcpB,KAAKT,aAIY,MAApCW,OAAOkC,0BACVlC,OAAOkC,0BAA4B,CAACtD,GAChCoB,OAAOkC,0BAA0BC,KAAKvD"}